<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>4. Routing • sfnetworks</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="4. Routing">
<meta property="og:description" content="sfnetworks">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">sfnetworks</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/sfn01_structure.html">1. The sfnetwork data structure</a>
    </li>
    <li>
      <a href="../articles/sfn02_preprocess_clean.html">2. Network pre-processing and cleaning</a>
    </li>
    <li>
      <a href="../articles/sfn03_join_filter.html">3. Spatial joins and filters</a>
    </li>
    <li>
      <a href="../articles/sfn04_routing.html">4. Routing</a>
    </li>
    <li>
      <a href="../articles/sfn05_morphers.html">5. Spatial morphers</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/luukvdmeer/sfnetworks/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="sfn04_routing_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>4. Routing</h1>
            
            <h4 class="date">2021-11-26</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/luukvdmeer/sfnetworks/blob/master/vignettes/sfn04_routing.Rmd"><code>vignettes/sfn04_routing.Rmd</code></a></small>
      <div class="hidden name"><code>sfn04_routing.Rmd</code></div>

    </div>

    
    
<style type="text/css" scoped>
PRE.fansi SPAN {padding-top: .25em; padding-bottom: .25em};
</style>
<p>Calculating shortest paths between pairs of nodes is a core task in network analysis. The <code>sfnetworks</code> package offers wrappers around the path calculation functions of <code>igraph</code>, making it easier to use them when working with spatial data and tidyverse packages. This vignette demonstrates their functionality.</p>
<p>In this regard it is important to remember that <code>sfnetworks</code> is a general-purpose package for spatial network analysis, not specifically optimized for a single task. If your <em>only</em> purpose is many-to-many routing in large networks, there might be other approaches that are faster and fit better to your needs. For example, the <a href="https://github.com/ATFutures/dodgr">dodgr</a> package was designed for many-to-many routing on large dual-weighted graphs, with its main focus on OpenStreetMap road network data. The <a href="https://github.com/vlarmet/cppRouting">cppRouting</a> package contains functions to calculate shortest paths and isochrones/isodistances on weighted graphs. When working with OpenStreetMap data, it is also possible to use the interfaces to external routing engines such as <a href="https://github.com/crazycapivara/graphhopper-r">graphhopper</a>, <a href="https://github.com/riatelab/osrm">osrm</a> and <a href="https://github.com/ropensci/opentripplanner">opentripplanner</a>. The <a href="https://github.com/ropensci/stplanr">stplanr</a> package for sustainable transport planning lets you use many routing engines from a single interface, through <code>stplanr::route()</code>, including routing using local R objects. Of course, all these packages can be happily used <em>alongside</em> <code>sfnetworks</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://luukvdmeer.github.io/sfnetworks/">sfnetworks</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidygraph.data-imaginist.com">tidygraph</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mhahsler/TSP">TSP</a></span><span class="op">)</span></code></pre></div>
<div id="setting-edge-weights" class="section level2">
<h2 class="hasAnchor">
<a href="#setting-edge-weights" class="anchor"></a>Setting edge weights</h2>
<p>The route of the shortest path between two nodes in a network is influenced by the <em>weights</em> or <em>impedance</em> of the edges. If you don’t provide these weights explicitly, shortest paths calculation functions in <code>sfnetworks</code> proceed as follows:</p>
<ul>
<li>If there is a column in the edges table named <em>weight</em>, the values in this column are automatically used as edge weights. These values are meant to be numeric. If they are not, <code>igraph</code> will silently try to convert them with <code><a href="https://rdrr.io/r/base/numeric.html">as.numeric()</a></code>.</li>
<li>If there is no <em>weight</em> column, <code><a href="../reference/st_network_paths.html">st_network_paths()</a></code> internally calculates the geographic lengths of the edges and uses those as weights.</li>
</ul>
<p>Every function that is about the calculation of shortest paths also accepts a <code>weights</code> argument which allows you to provide edge weights explicitly. In <code>sfnetworks</code>, this argument can be a numeric vector of the same length as the number of edges in the network, but also the name of a column in the edges table. The <code>weights</code> argument will always overrule the default behavior of using the <em>weight</em> column for edge weights. If you have a <em>weight</em> column but want to calculate paths <em>without</em> using weights, set <code>weights = NA</code>. In practice that means that the weight of all edges is equal to 1. Hence, the shortest path between node A and node B is the path with the fewest <em>number</em> of edges.</p>
<p>The <code><a href="../reference/spatial_edge_measures.html">edge_length()</a></code> function can be used to calculate the length of each edge in geographic space, such that you can use those as weights in shortest paths calculations. The function is meant to be used inside a <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">dplyr::mutate()</a></code> verb, as follows:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">net</span> <span class="op">=</span> <span class="fu"><a href="../reference/as_sfnetwork.html">as_sfnetwork</a></span><span class="op">(</span><span class="va">roxel</span>, directed <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="fl">3035</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html">activate</a></span><span class="op">(</span><span class="st">"edges"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>weight <span class="op">=</span> <span class="fu"><a href="../reference/spatial_edge_measures.html">edge_length</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">net</span></code></pre></div>
<pre class="fansi fansi-output"><code>#&gt; <span style="color: #555555;"># A sfnetwork with</span> <span style="color: #555555;">701</span> <span style="color: #555555;">nodes and</span> <span style="color: #555555;">851</span> <span style="color: #555555;">edges
#&gt; #
#&gt; # CRS: </span> <span style="color: #555555;">EPSG:3035</span> <span style="color: #555555;">
#&gt; #
#&gt; # An undirected multigraph with 14 components with spatially explicit edges
#&gt; #
#&gt; # Edge Data:     851 × 6 (active)</span>
#&gt; <span style="color: #555555;"># Geometry type: LINESTRING</span>
#&gt; <span style="color: #555555;"># Dimension:     XY</span>
#&gt; <span style="color: #555555;"># Bounding box:  xmin: 4150707 ymin: 3206375 xmax: 4152367 ymax: 3208565</span>
#&gt;    from    to name                  type                         geometry weight
#&gt;   <span style="color: #555555; font-style: italic;">&lt;int&gt;</span> <span style="color: #555555; font-style: italic;">&lt;int&gt;</span> <span style="color: #555555; font-style: italic;">&lt;chr&gt;</span>                 <span style="color: #555555; font-style: italic;">&lt;fct&gt;</span>                <span style="color: #555555; font-style: italic;">&lt;LINESTRING [m]&gt;</span>    <span style="color: #555555;">[m]</span>
#&gt; <span style="color: #555555;">1</span>     1     2 Havixbecker Strasse   residential (4151491 3207923, 415147…   28.9
#&gt; <span style="color: #555555;">2</span>     3     4 Pienersallee          secondary   (4151398 3207777, 415139…  108. 
#&gt; <span style="color: #555555;">3</span>     5     6 Schulte-Bernd-Strasse residential (4151408 3207539, 415141…   54.4
#&gt; <span style="color: #555555;">4</span>     7     8 <span style="color: #BB0000;">NA</span>                    path        (4151885 3206698, 415186…  155. 
#&gt; <span style="color: #555555;">5</span>     9    10 Welsingheide          residential (4151732 3207017, 415172…  209. 
#&gt; <span style="color: #555555;">6</span>    11    12 <span style="color: #BB0000;">NA</span>                    footway     (4152152 3206984, 415214…   63.0
#&gt; <span style="color: #555555;"># … with 845 more rows</span>
#&gt; <span style="color: #555555;">#
#&gt; # Node Data:     701 × 1</span>
#&gt; <span style="color: #555555;"># Geometry type: POINT</span>
#&gt; <span style="color: #555555;"># Dimension:     XY</span>
#&gt; <span style="color: #555555;"># Bounding box:  xmin: 4150707 ymin: 3206375 xmax: 4152367 ymax: 3208565</span>
#&gt;            geometry
#&gt;         <span style="color: #555555; font-style: italic;">&lt;POINT [m]&gt;</span>
#&gt; <span style="color: #555555;">1</span> (4151491 3207923)
#&gt; <span style="color: #555555;">2</span> (4151474 3207946)
#&gt; <span style="color: #555555;">3</span> (4151398 3207777)
#&gt; <span style="color: #555555;"># … with 698 more rows</span>
</code></pre>
<p>It is important to mention that <code>tidygraph</code> does not always comply with the default <code>igraph</code> behaviors as we described them above. For example, when using tidygraphs centrality functions, you <em>have</em> to explicity set <code>weights = weight</code> when you want to use your <em>weight</em> column as edge weights in the centrality calculation. If the <code>weights</code> argument is not set (i.e. <code>weights = NULL</code>) it will not use any edge weights.</p>
</div>
<div id="calculating-shortest-paths" class="section level2">
<h2 class="hasAnchor">
<a href="#calculating-shortest-paths" class="anchor"></a>Calculating shortest paths</h2>
<p>The function <code><a href="../reference/st_network_paths.html">st_network_paths()</a></code> is a wrapper around the igraph function <code><a href="https://rdrr.io/pkg/igraph/man/distances.html">igraph::shortest_paths()</a></code>. There are three main differences:</p>
<ul>
<li>Besides node indices and node names, <code><a href="../reference/st_network_paths.html">st_network_paths()</a></code> gives the additional option to provide any (set of) geospatial point(s) as <em>from</em> and <em>to</em> location(s) of the shortest paths, either as sf or sfc object. Provided points that do not equal any node in the network will be snapped to their nearest node before calculating the paths.</li>
<li>To allow smooth integration with the tidyverse, the output of <code><a href="../reference/st_network_paths.html">st_network_paths()</a></code> is a tibble, with one row per returned path. The column <em>node_paths</em> contains the ordered list of node indices in the path, and the column <em>edge_paths</em> contains the ordered list of edge indices in the path.</li>
<li>Whenever there is no column in the edges table named <em>weight</em> and the <code>weights</code> argument is not set (i.e. <code>weights = NULL</code>), <code><a href="../reference/st_network_paths.html">st_network_paths()</a></code> by default uses the geographic edge length as weight.</li>
</ul>
<p>Just as <code><a href="https://rdrr.io/pkg/igraph/man/distances.html">igraph::shortest_paths()</a></code>, the <code><a href="../reference/st_network_paths.html">st_network_paths()</a></code> function is meant for one-to-one and one-to-many routing. Hence, it is only possible to provide a single <em>from</em> location, while the <em>to</em> locations can be more than one.</p>
<p>Lets start with the most basic example of providing node indices as <em>from</em> and <em>to</em> locations. Remember that a node index in a sfnetwork refers to the position of the node in the nodes table of the network (i.e. its row number). There is also the possibility to use character encoded node names instead of numeric node indices. This requires the nodes table to have a column <em>name</em> with a unique name for each node.</p>
<p>Since we have created a <em>weight</em> column in the previous section, these weights (i.e. the length of the edge geometries) will be used automatically in the shortest paths calculation. In weighted networks, <code><a href="https://rdrr.io/pkg/igraph/man/distances.html">igraph::shortest_paths()</a></code> applies the Dijkstra algorithm to find the shortest paths. In the case of unweighted networks, it uses breadth-first search instead.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">paths</span> <span class="op">=</span> <span class="fu"><a href="../reference/st_network_paths.html">st_network_paths</a></span><span class="op">(</span><span class="va">net</span>, from <span class="op">=</span> <span class="fl">495</span>, to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">458</span>, <span class="fl">121</span><span class="op">)</span><span class="op">)</span>
<span class="va">paths</span></code></pre></div>
<pre class="fansi fansi-output"><code>#&gt; <span style="color: #555555;"># A tibble: 2 × 2</span>
#&gt;   node_paths edge_paths
#&gt;   <span style="color: #555555; font-style: italic;">&lt;list&gt;</span>     <span style="color: #555555; font-style: italic;">&lt;list&gt;</span>    
#&gt; <span style="color: #555555;">1</span> <span style="color: #555555;">&lt;int [29]&gt;</span> <span style="color: #555555;">&lt;int [28]&gt;</span>
#&gt; <span style="color: #555555;">2</span> <span style="color: #555555;">&lt;int [33]&gt;</span> <span style="color: #555555;">&lt;int [32]&gt;</span>
</code></pre>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">paths</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">node_paths</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt;  [1] 495 485 244 402 166  18 195 181  68 100 169 170 182 101 103 547 546 554 556</span>
<span class="co">#&gt; [20] 555  86  61  88 531 543  90 229 527 458</span>

<span class="va">paths</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">edge_paths</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt;  [1] 311 757 670 671  93 117 116 106  54  96  97 502 501 414 413 402 791 423 422</span>
<span class="co">#&gt; [20] 788 392 393 394 779 395 540 539 357</span>

<span class="va">plot_path</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">node_path</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">net</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html">activate</a></span><span class="op">(</span><span class="st">"nodes"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="va">node_path</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span>cex <span class="op">=</span> <span class="fl">1.5</span>, lwd <span class="op">=</span> <span class="fl">1.5</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">colors</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">sf.colors</a></span><span class="op">(</span><span class="fl">3</span>, categorical <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">net</span>, col <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span>
<span class="va">paths</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">node_paths</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">walk</a></span><span class="op">(</span><span class="va">plot_path</span><span class="op">)</span>
<span class="va">net</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html">activate</a></span><span class="op">(</span><span class="st">"nodes"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">495</span>, <span class="fl">121</span>, <span class="fl">458</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span>col <span class="op">=</span> <span class="va">colors</span>, pch <span class="op">=</span> <span class="fl">8</span>, cex <span class="op">=</span> <span class="fl">2</span>, lwd <span class="op">=</span> <span class="fl">2</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p><img src="sfn04_routing_files/figure-html/unnamed-chunk-3-1.png" width="480"></p>
<p>Next we will create some geospatial points that do not intersect with any node in the network. Providing them to <code><a href="../reference/st_network_paths.html">st_network_paths()</a></code> will first find the nearest node to each of them, and then calculate the shortest paths accordingly.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">p1</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">net</span>, <span class="st">"nodes"</span><span class="op">)</span><span class="op">[</span><span class="fl">495</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html">st_sfc</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">50</span>, <span class="op">-</span><span class="fl">50</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">p1</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">net</span><span class="op">)</span>
<span class="va">p2</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">net</span>, <span class="st">"nodes"</span><span class="op">)</span><span class="op">[</span><span class="fl">458</span><span class="op">]</span>
<span class="va">p3</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">net</span>, <span class="st">"nodes"</span><span class="op">)</span><span class="op">[</span><span class="fl">121</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html">st_sfc</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">p3</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">net</span><span class="op">)</span>

<span class="va">paths</span> <span class="op">=</span> <span class="fu"><a href="../reference/st_network_paths.html">st_network_paths</a></span><span class="op">(</span><span class="va">net</span>, from <span class="op">=</span> <span class="va">p1</span>, to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">p2</span>, <span class="va">p3</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">net</span>, col <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span>
<span class="va">paths</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">node_paths</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">walk</a></span><span class="op">(</span><span class="va">plot_path</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">p2</span>, <span class="va">p3</span><span class="op">)</span>, col <span class="op">=</span> <span class="va">colors</span>, pch <span class="op">=</span> <span class="fl">8</span>, cex <span class="op">=</span> <span class="fl">2</span>, lwd <span class="op">=</span> <span class="fl">2</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p><img src="sfn04_routing_files/figure-html/unnamed-chunk-4-1.png" width="480"></p>
<p>Simply finding the nearest node to given points is not always the best way to go. For example: when a provided point is close to a location on an edge linestring, but relatively far from any node, it gives better results when the routing does not start at its nearest node, but at that nearby location on the edge linestring. To accommodate this, you can first <em>blend</em> your input points into the network, and then proceed as normal. Blending is the name we gave to the combined process of snapping a point to its nearest point on its nearest edge, splitting the edge there, and adding the snapped point as node to the network. It is implement in the function <code><a href="../reference/st_network_blend.html">st_network_blend()</a></code>. See the vignette on <a href="https://luukvdmeer.github.io/sfnetworks/articles/join_filter.html#blending-points-into-a-network">spatial joins and filters</a> for more details.</p>
<p>Another issue may arise wen your network consists of multiple components that are not connected to each other. In that case, it is possible that the nearest node to a provided point is located in a tiny component and only a few other nodes can be reached from it. In such cases it might be good to first reduce the network to its largest (or <em>n</em> largest) component(s) before calculating shortest paths. The tidygraph function <code><a href="https://tidygraph.data-imaginist.com/reference/group_graph.html">tidygraph::group_components()</a></code> can help with this. It assigns an integer to each node identifying the component it is in, with <code>1</code> being the largest component in the network, <code>2</code> the second largest, and so on.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Our network consists of several unconnected components.</span>
<span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/with_graph.html">with_graph</a></span><span class="op">(</span><span class="va">net</span>, <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/graph_measures.html">graph_component_count</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] 14</span>

<span class="va">connected_net</span> <span class="op">=</span> <span class="va">net</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html">activate</a></span><span class="op">(</span><span class="st">"nodes"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/group_graph.html">group_components</a></span><span class="op">(</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>

<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">net</span>, col <span class="op">=</span> <span class="va">colors</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">connected_net</span>, cex <span class="op">=</span> <span class="fl">1.1</span>, lwd <span class="op">=</span> <span class="fl">1.1</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p><img src="sfn04_routing_files/figure-html/unnamed-chunk-5-1.png" width="480"></p>
<p>Another way to calculate shortest paths, which fits nicely in the tidygraph style of working, is by using the <code><a href="../reference/spatial_morphers.html">to_spatial_shortest_paths()</a></code> morpher function. This will subset the original network to only contain those nodes and edges that appear in a shortest path between two nodes. See the vignette on <a href="https://luukvdmeer.github.io/sfnetworks/articles/morphers.html#to_spatial_shortest_paths">Spatial morphers</a> for details.</p>
</div>
<div id="retrieving-an-od-cost-matrix" class="section level2">
<h2 class="hasAnchor">
<a href="#retrieving-an-od-cost-matrix" class="anchor"></a>Retrieving an OD cost matrix</h2>
<p>The shortest paths calculation as described above is only supported for one-to-one and one-to-many routing. The alternative for many-to-many routing is the calculation of an origin-destination cost matrix. Instead of providing the individual paths, it returns a matrix in which entry <span class="math inline">\(i,j\)</span> is the total cost (i.e. sum of weights) of the shortest path from node <span class="math inline">\(i\)</span> to node <span class="math inline">\(j\)</span>. The origin-destination cost matrix is usually an important starting point for further analysis. For example, it can serve as input to route optimization algorithms, spatial clustering algorithms and the calculation of statistical measures based on spatial proximity.</p>
<p>The igraph function for this purpose is <code><a href="https://rdrr.io/pkg/igraph/man/distances.html">igraph::distances()</a></code>, which in <code>sfnetworks</code> is wrapped by <code><a href="../reference/st_network_cost.html">st_network_cost()</a></code>, allowing again to provide sets of geospatial points as <em>from</em> and <em>to</em> locations. Note that the calculated costs refer to the paths between the <em>nearest nodes</em> of the input points. Their units are the same as the units of weights used in the calculation, in this case meters.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/st_network_cost.html">st_network_cost</a></span><span class="op">(</span><span class="va">net</span>, from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">p2</span>, <span class="va">p3</span><span class="op">)</span>, to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">p2</span>, <span class="va">p3</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;          [,1]     [,2]     [,3]</span>
<span class="co">#&gt; [1,]    0.000 1614.252 2094.555</span>
<span class="co">#&gt; [2,] 1614.252    0.000 1315.965</span>
<span class="co">#&gt; [3,] 2094.555 1315.965    0.000</span></code></pre></div>
<p>If we don’t provide any from and to points, <code><a href="../reference/st_network_cost.html">st_network_cost()</a></code> will by default calculate the cost matrix for the entire network.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Our network has 701 nodes.</span>
<span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/with_graph.html">with_graph</a></span><span class="op">(</span><span class="va">net</span>, <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/graph_measures.html">graph_order</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] 701</span>

<span class="va">cost_matrix</span> <span class="op">=</span> <span class="fu"><a href="../reference/st_network_cost.html">st_network_cost</a></span><span class="op">(</span><span class="va">net</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">cost_matrix</span><span class="op">)</span>
<span class="co">#&gt; [1] 701 701</span></code></pre></div>
<p>All <code>...</code> arguments are forwarded internally to <code><a href="https://rdrr.io/pkg/igraph/man/distances.html">igraph::distances()</a></code>. Among other options, this means that you can define which algorithm is used for the paths calculation. By default, <code>igraph</code> will choose the most suitable algorithm based on characteristics of the request, such as the type of weights (e.g. only positive or also negative) and the number of given from locations. For details, see the <a href="https://igraph.org/r/doc/distances.html">igraph documentation</a>.</p>
<p>In directed networks, it also gives you the possibility to define if you want to allow travel only over outbound edges (by setting <code>mode = "out"</code>), only over inbound edges (by setting <code>mode = "in"</code>), or both (by setting <code>mode = "all"</code>, i.e. assume an undirected network). It is important to note that even in directed networks the latter is the default!</p>
</div>
<div id="applications" class="section level2">
<h2 class="hasAnchor">
<a href="#applications" class="anchor"></a>Applications</h2>
<p>In this section, we will show a small set of applications of the routing related functions. It is definitely not meant to be an overview that covers everything! Also, remember again that <code>sfnetworks</code> is a general-purpose spatial network analysis package not optimized for a specific application. However, especially in combination with other packages it can address a wide variety of use-cases.</p>
<div id="closest-facility-analysis" class="section level3">
<h3 class="hasAnchor">
<a href="#closest-facility-analysis" class="anchor"></a>Closest facility analysis</h3>
<p>The purpose of closest facility analysis is, given a set of destination locations (also referred to as the <em>facilities</em>) and origin locations (also referred to as the <em>sites</em>), to find the closest <em>n</em> facilities to each site. For example, you might want to find the nearest transit hub for each address in a city, or the nearest hospital to high-risk road intersections.</p>
<p>To solve this problem, you can calculate the OD cost matrix with the sites as <em>from</em> points, and the facilities as <em>to</em> points. Then, for each row (i.e. each site) you find the column(s) with the lowest cost value.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Select a random set of sites and facilities.</span>
<span class="co"># We select random locations within the bounding box of the nodes.</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">128</span><span class="op">)</span>
<span class="va">hull</span> <span class="op">=</span> <span class="va">net</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html">activate</a></span><span class="op">(</span><span class="st">"nodes"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html">st_combine</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_convex_hull</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">sites</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_sample.html">st_sample</a></span><span class="op">(</span><span class="va">hull</span>, <span class="fl">50</span>, type <span class="op">=</span> <span class="st">"random"</span><span class="op">)</span>
<span class="va">facilities</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_sample.html">st_sample</a></span><span class="op">(</span><span class="va">hull</span>, <span class="fl">5</span>, type <span class="op">=</span> <span class="st">"random"</span><span class="op">)</span>

<span class="co"># Blend the sites and facilities into the network to get better results.</span>
<span class="co"># Also select only the largest connected component.</span>
<span class="va">new_net</span> <span class="op">=</span> <span class="va">net</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html">activate</a></span><span class="op">(</span><span class="st">"nodes"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/group_graph.html">group_components</a></span><span class="op">(</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/st_network_blend.html">st_network_blend</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">sites</span>, <span class="va">facilities</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Warning: st_network_blend assumes attributes are constant over geometries</span>

<span class="co"># Calculate the cost matrix.</span>
<span class="co"># By default the weight column is used for edge weights.</span>
<span class="co"># In our case this column contains the geographic lengths of the edges.</span>
<span class="va">cost_matrix</span> <span class="op">=</span> <span class="fu"><a href="../reference/st_network_cost.html">st_network_cost</a></span><span class="op">(</span><span class="va">new_net</span>, from <span class="op">=</span> <span class="va">sites</span>, to <span class="op">=</span> <span class="va">facilities</span><span class="op">)</span>

<span class="co"># Find for each site which facility is closest.</span>
<span class="va">closest</span> <span class="op">=</span> <span class="va">facilities</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">cost_matrix</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">x</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">]</span>

<span class="co"># Create a line between each site and its closest facility, for visualization.</span>
<span class="va">draw_lines</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">sources</span>, <span class="va">targets</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">lines</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mapply.html">mapply</a></span><span class="op">(</span>
    <span class="kw">function</span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span><span class="op">)</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html">st_sfc</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html">st_cast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span><span class="op">)</span>, <span class="st">"LINESTRING"</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">net</span><span class="op">)</span><span class="op">)</span>,
    <span class="va">sources</span>,
    <span class="va">targets</span>,
    SIMPLIFY <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="st">"c"</span>, <span class="va">lines</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">connections</span> <span class="op">=</span> <span class="fu">draw_lines</span><span class="op">(</span><span class="va">sites</span>, <span class="va">closest</span><span class="op">)</span>

<span class="co"># Plot the results.</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">new_net</span>, col <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">connections</span>, col <span class="op">=</span> <span class="va">colors</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, lwd <span class="op">=</span> <span class="fl">2</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">facilities</span>, pch <span class="op">=</span> <span class="fl">8</span>, cex <span class="op">=</span> <span class="fl">2</span>, lwd <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="va">colors</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">sites</span>, pch <span class="op">=</span> <span class="fl">20</span>, cex <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="va">colors</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p><img src="sfn04_routing_files/figure-html/unnamed-chunk-8-1.png" width="480"></p>
</div>
<div id="route-optimization" class="section level3">
<h3 class="hasAnchor">
<a href="#route-optimization" class="anchor"></a>Route optimization</h3>
<p>The traveling salesman problem aims to find the shortest tour that visits a set of locations exactly once and then returns to the starting location. In <code>sfnetworks</code>, there are no dedicated functions to solve this. However, we can bring in other packages here to assist us. Probably the best known R package for solving traveling salesman problems is <a href="https://CRAN.R-project.org/package=TSP">TSP</a>. To do so, it requires a matrix that specifies the travel cost between each pair of locations. As shown above, we can use <code>sfnetworks</code> to calculate such a cost matrix for our network.</p>
<p>Lets first generate a set of random points within the bounding box of the network. These will serve as the locations the traveling salesman has to visit.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">403</span><span class="op">)</span>
<span class="va">rdm</span> <span class="op">=</span> <span class="va">net</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sfc.html">st_as_sfc</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_sample.html">st_sample</a></span><span class="op">(</span><span class="fl">10</span>, type <span class="op">=</span> <span class="st">"random"</span><span class="op">)</span></code></pre></div>
<p>We can then compute the cost matrix using <code><a href="../reference/st_network_cost.html">st_network_cost()</a></code>. Internally, it will first snap the provided points to their nearest node in the network, and then use the <em>weight</em> column to calculate the travel costs between these nodes. Passing the matrix to <code><a href="https://rdrr.io/pkg/TSP/man/TSP.html">TSP::TSP()</a></code> will make it suitable for usage inside the <code>TSP</code> package.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">net</span> <span class="op">=</span> <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html">activate</a></span><span class="op">(</span><span class="va">net</span>, <span class="st">"nodes"</span><span class="op">)</span>
<span class="va">cost_matrix</span> <span class="op">=</span> <span class="fu"><a href="../reference/st_network_cost.html">st_network_cost</a></span><span class="op">(</span><span class="va">net</span>, from <span class="op">=</span> <span class="va">rdm</span>, to <span class="op">=</span> <span class="va">rdm</span><span class="op">)</span>

<span class="co"># Use nearest node indices as row and column names.</span>
<span class="va">rdm_idxs</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_nearest_feature.html">st_nearest_feature</a></span><span class="op">(</span><span class="va">rdm</span>, <span class="va">net</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/row.names.html">row.names</a></span><span class="op">(</span><span class="va">cost_matrix</span><span class="op">)</span> <span class="op">=</span> <span class="va">rdm_idxs</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">cost_matrix</span><span class="op">)</span> <span class="op">=</span> <span class="va">rdm_idxs</span>

<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">cost_matrix</span>, <span class="fl">0</span><span class="op">)</span>
<span class="co">#&gt;      252  545  698   15  224  323   31  510   71   61</span>
<span class="co">#&gt; 252    0  914 1335 1947 1010 1122  776 1052 1365 1204</span>
<span class="co">#&gt; 545  914    0  421 1575  503  358  962  680  451  291</span>
<span class="co">#&gt; 698 1335  421    0 1552  590  241 1383 1031  227  130</span>
<span class="co">#&gt; 15  1947 1575 1552    0 2046 1408 1314 1015 1616 1620</span>
<span class="co">#&gt; 224 1010  503  590 2046    0  767 1155 1151  551  459</span>
<span class="co">#&gt; 323 1122  358  241 1408  767    0 1170  800  304  308</span>
<span class="co">#&gt; 31   776  962 1383 1314 1155 1170    0  796 1413 1252</span>
<span class="co">#&gt; 510 1052  680 1031 1015 1151  800  796    0 1094  970</span>
<span class="co">#&gt; 71  1365  451  227 1616  551  304 1413 1094    0  161</span>
<span class="co">#&gt; 61  1204  291  130 1620  459  308 1252  970  161    0</span></code></pre></div>
<p>By passing the cost matrix to the solver <code><a href="https://rdrr.io/pkg/TSP/man/solve_TSP.html">TSP::solve_TSP()</a></code> we obtain an object of class <code>TOUR</code>. This object contains a named vector specifying the indices of the provided locations in the optimal order of visit.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tour</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/TSP/man/solve_TSP.html">solve_TSP</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/TSP/man/TSP.html">TSP</a></span><span class="op">(</span><span class="va">cost_matrix</span><span class="op">)</span><span class="op">)</span>
<span class="va">tour_idxs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">tour</span><span class="op">)</span><span class="op">)</span>
<span class="va">tour_idxs</span>
<span class="co">#&gt;  [1]  71  61 545 224 252  31  15 510 323 698</span>

<span class="co"># Approximate length of the route.</span>
<span class="co"># In meters, since that was the unit of our cost values.</span>
<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/TSP/man/tour_length.html">tour_length</a></span><span class="op">(</span><span class="va">tour</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span>
<span class="co">#&gt; [1] 6337</span></code></pre></div>
<p>Knowing the optimal order to visit all provided locations, we move back to <code>sfnetworks</code> to match this route to the network. We do so by computing the shortest paths between each location and its subsequent one, until we reach the starting point again.</p>
<p>For more details on solving travelling salesman problems in R, see the <a href="https://CRAN.R-project.org/package=TSP">TSP package documentation</a>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Define the nodes to calculate the shortest paths from.</span>
<span class="co"># Define the nodes to calculate the shortest paths to.</span>
<span class="co"># All based on the calculated order of visit.</span>
<span class="va">from_idxs</span> <span class="op">=</span> <span class="va">tour_idxs</span>
<span class="va">to_idxs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">tour_idxs</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">tour_idxs</span><span class="op">)</span><span class="op">]</span>, <span class="va">tour_idxs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>

<span class="co"># Calculate the specified paths.</span>
<span class="va">tsp_paths</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mapply.html">mapply</a></span><span class="op">(</span><span class="va">st_network_paths</span>,
    from <span class="op">=</span> <span class="va">from_idxs</span>,
    to <span class="op">=</span> <span class="va">to_idxs</span>,
    MoreArgs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">net</span><span class="op">)</span>
  <span class="op">)</span><span class="op">[</span><span class="st">"node_paths"</span>, <span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span>recursive <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="co"># Plot the results.</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">net</span>, col <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">rdm</span>, pch <span class="op">=</span> <span class="fl">20</span>, col <span class="op">=</span> <span class="va">colors</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">walk</a></span><span class="op">(</span><span class="va">tsp_paths</span>, <span class="va">plot_path</span><span class="op">)</span> <span class="co"># Reuse the plot_path function defined earlier.</span>

<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="va">net</span>, <span class="va">rdm_idxs</span><span class="op">)</span><span class="op">)</span>,
  pch <span class="op">=</span> <span class="fl">20</span>, col <span class="op">=</span> <span class="va">colors</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, add <span class="op">=</span> <span class="cn">TRUE</span>
<span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="va">net</span>, <span class="va">tour_idxs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,
  pch <span class="op">=</span> <span class="fl">8</span>, cex <span class="op">=</span> <span class="fl">2</span>, lwd <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="va">colors</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, add <span class="op">=</span> <span class="cn">TRUE</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html">st_coordinates</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="va">net</span>, <span class="va">tour_idxs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">200</span>, <span class="fl">90</span><span class="op">)</span>,
  labels <span class="op">=</span> <span class="st">"start/end\npoint"</span>
<span class="op">)</span></code></pre></div>
<p><img src="sfn04_routing_files/figure-html/unnamed-chunk-12-1.png" width="480"></p>
</div>
<div id="isochrones-and-isodistances" class="section level3">
<h3 class="hasAnchor">
<a href="#isochrones-and-isodistances" class="anchor"></a>Isochrones and isodistances</h3>
<p>With respect to a given point <span class="math inline">\(p\)</span> and a given travel time <span class="math inline">\(t\)</span>, an isochrone is the line for which it holds that the travel time from any point on the line to or from <span class="math inline">\(p\)</span> is equal to <span class="math inline">\(t\)</span>. When using distances instead of time, it is called an isodistance.</p>
<p>In <code>sfnetworks</code> there are no dedicated, optimized functions for calculating isochrones or isodistances. However, we can roughly approximate them by using a combination of sf and tidygraph functions. Lets first calculate imaginary travel times for each edge, using randomly generated average walking speeds for each type of edge.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># How many edge types are there?</span>
<span class="va">types</span> <span class="op">=</span> <span class="va">net</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html">activate</a></span><span class="op">(</span><span class="st">"edges"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">type</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">types</span>
<span class="co">#&gt; [1] residential  secondary    path         footway      track       </span>
<span class="co">#&gt; [6] unclassified pedestrian   service      cycleway    </span>
<span class="co">#&gt; 9 Levels: cycleway footway path pedestrian residential secondary ... unclassified</span>

<span class="co"># Randomly define a walking speed in m/s for each type.</span>
<span class="co"># With values between 3 and 7 km/hr.</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="va">speeds</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">types</span><span class="op">)</span>, <span class="fl">3</span> <span class="op">*</span> <span class="fl">1000</span> <span class="op">/</span> <span class="fl">60</span> <span class="op">/</span> <span class="fl">60</span>, <span class="fl">7</span> <span class="op">*</span> <span class="fl">1000</span> <span class="op">/</span> <span class="fl">60</span> <span class="op">/</span> <span class="fl">60</span><span class="op">)</span>

<span class="co"># Assign a speed to each edge based on its type.</span>
<span class="co"># Calculate travel time for each edge based on that.</span>
<span class="va">net</span> <span class="op">=</span> <span class="va">net</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html">activate</a></span><span class="op">(</span><span class="st">"edges"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">type</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>speed <span class="op">=</span> <span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/units/man/units.html">set_units</a></span><span class="op">(</span><span class="va">speeds</span><span class="op">[</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">cur_group_id</a></span><span class="op">(</span><span class="op">)</span><span class="op">]</span>, <span class="st">"m/s"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>time <span class="op">=</span> <span class="va">weight</span> <span class="op">/</span> <span class="va">speed</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">net</span></code></pre></div>
<pre class="fansi fansi-output"><code>#&gt; <span style="color: #555555;"># A sfnetwork with</span> <span style="color: #555555;">701</span> <span style="color: #555555;">nodes and</span> <span style="color: #555555;">851</span> <span style="color: #555555;">edges
#&gt; #
#&gt; # CRS: </span> <span style="color: #555555;">EPSG:3035</span> <span style="color: #555555;">
#&gt; #
#&gt; # An undirected multigraph with 14 components with spatially explicit edges
#&gt; #
#&gt; # Edge Data:     851 × 8 (active)</span>
#&gt; <span style="color: #555555;"># Geometry type: LINESTRING</span>
#&gt; <span style="color: #555555;"># Dimension:     XY</span>
#&gt; <span style="color: #555555;"># Bounding box:  xmin: 4150707 ymin: 3206375 xmax: 4152367 ymax: 3208565</span>
#&gt;    from    to name     type                          geometry weight speed  time
#&gt;   <span style="color: #555555; font-style: italic;">&lt;int&gt;</span> <span style="color: #555555; font-style: italic;">&lt;int&gt;</span> <span style="color: #555555; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #555555; font-style: italic;">&lt;fct&gt;</span>                 <span style="color: #555555; font-style: italic;">&lt;LINESTRING [m]&gt;</span>    <span style="color: #555555;">[m]</span> <span style="color: #555555;">[m/s]</span>   <span style="color: #555555;">[s]</span>
#&gt; <span style="color: #555555;">1</span>     1     2 Havixbe… resi… (4151491 3207923, 4151474 32079…   28.9  1.06  27.3
#&gt; <span style="color: #555555;">2</span>     3     4 Pieners… seco… (4151398 3207777, 4151390 32077…  108.   1.83  58.8
#&gt; <span style="color: #555555;">3</span>     5     6 Schulte… resi… (4151408 3207539, 4151417 32075…   54.4  1.06  51.4
#&gt; <span style="color: #555555;">4</span>     7     8 <span style="color: #BB0000;">NA</span>       path  (4151885 3206698, 4151861 32067…  155.   1.47 106. 
#&gt; <span style="color: #555555;">5</span>     9    10 Welsing… resi… (4151732 3207017, 4151721 32068…  209.   1.06 197. 
#&gt; <span style="color: #555555;">6</span>    11    12 <span style="color: #BB0000;">NA</span>       foot… (4152152 3206984, 4152143 32069…   63.0  1.25  50.6
#&gt; <span style="color: #555555;"># … with 845 more rows</span>
#&gt; <span style="color: #555555;">#
#&gt; # Node Data:     701 × 1</span>
#&gt; <span style="color: #555555;"># Geometry type: POINT</span>
#&gt; <span style="color: #555555;"># Dimension:     XY</span>
#&gt; <span style="color: #555555;"># Bounding box:  xmin: 4150707 ymin: 3206375 xmax: 4152367 ymax: 3208565</span>
#&gt;            geometry
#&gt;         <span style="color: #555555; font-style: italic;">&lt;POINT [m]&gt;</span>
#&gt; <span style="color: #555555;">1</span> (4151491 3207923)
#&gt; <span style="color: #555555;">2</span> (4151474 3207946)
#&gt; <span style="color: #555555;">3</span> (4151398 3207777)
#&gt; <span style="color: #555555;"># … with 698 more rows</span>
</code></pre>
<p>Now, we can calculate the total travel time for each shortest path between the (nearest node of the) origin point and all other nodes in the network, using the node measure function <code><a href="https://tidygraph.data-imaginist.com/reference/pair_measures.html">tidygraph::node_distance_from()</a></code> with the values in the <em>time</em> column as weights. Then, we filter the nodes reachable within a given travel time from the origin. By drawing a convex hull around these selected nodes we roughly approximate the isochrone. If we wanted isochrones for travel times <em>towards</em> the central point, we could have used the node measure function <code><a href="https://tidygraph.data-imaginist.com/reference/pair_measures.html">tidygraph::node_distance_to()</a></code> instead.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">net</span> <span class="op">=</span> <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html">activate</a></span><span class="op">(</span><span class="va">net</span>, <span class="st">"nodes"</span><span class="op">)</span>

<span class="va">p</span> <span class="op">=</span> <span class="va">net</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html">st_combine</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_centroid</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">iso</span> <span class="op">=</span> <span class="va">net</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/pair_measures.html">node_distance_from</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_nearest_feature.html">st_nearest_feature</a></span><span class="op">(</span><span class="va">p</span>, <span class="va">net</span><span class="op">)</span>, weights <span class="op">=</span> <span class="va">time</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">600</span><span class="op">)</span>

<span class="va">iso_poly</span> <span class="op">=</span> <span class="va">iso</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html">st_combine</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_convex_hull</a></span><span class="op">(</span><span class="op">)</span>

<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">net</span>, col <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">iso_poly</span>, col <span class="op">=</span> <span class="cn">NA</span>, border <span class="op">=</span> <span class="st">"black"</span>, lwd <span class="op">=</span> <span class="fl">3</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">iso</span>, col <span class="op">=</span> <span class="va">colors</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">p</span>, col <span class="op">=</span> <span class="va">colors</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, pch <span class="op">=</span> <span class="fl">8</span>, cex <span class="op">=</span> <span class="fl">2</span>, lwd <span class="op">=</span> <span class="fl">2</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p><img src="sfn04_routing_files/figure-html/unnamed-chunk-14-1.png" width="480"></p>
<p>The workflow presented above is generalized in a spatial morpher function <code><a href="../reference/spatial_morphers.html">to_spatial_neighborhood()</a></code>, which can be used inside the <code><a href="https://tidygraph.data-imaginist.com/reference/morph.html">tidygraph::convert()</a></code> verb to filter only those nodes that can be reached within a given travel cost from the given origin node. See the vignette on <a href="https://luukvdmeer.github.io/sfnetworks/articles/morphers.html#to_spatial_neighborhood">Spatial morphers</a> for details.</p>
</div>
<div id="custom-routing" class="section level3">
<h3 class="hasAnchor">
<a href="#custom-routing" class="anchor"></a>Custom routing</h3>
<p>In many cases the shortest path based geographical distances or travel time is not necessarily the optimal path. The most appropriate route may depend on many factors, for example staying away from large and potentially unpleasant highways for motor traffic. All networks have different characteristics. In OpenStreetMap networks the ‘highway’ type is often a good (albeit crude) approximation of the network. The <code>roxel</code> demo dataset is derived from OpenStreetMap and represents a largely residential network:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">roxel</span><span class="op">$</span><span class="va">type</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     cycleway      footway         path   pedestrian  residential    secondary </span>
<span class="co">#&gt;           42           67           95            1          394           62 </span>
<span class="co">#&gt;      service        track unclassified </span>
<span class="co">#&gt;          160            5           25</span></code></pre></div>
<p>Building on the shortest paths calculated in a previous section we can try an alternative routing profile. Let’s take a look at these paths to see what type of ways they travel on:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">paths_sf</span> <span class="op">=</span> <span class="va">net</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html">activate</a></span><span class="op">(</span><span class="st">"edges"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="va">paths</span><span class="op">$</span><span class="va">edge_paths</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">paths_sf</span><span class="op">$</span><span class="va">type</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     cycleway      footway         path   pedestrian  residential    secondary </span>
<span class="co">#&gt;            2            0            6            0           38            1 </span>
<span class="co">#&gt;      service        track unclassified </span>
<span class="co">#&gt;            2            0            6</span>

<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">paths_sf</span><span class="op">[</span><span class="st">"type"</span><span class="op">]</span>, lwd <span class="op">=</span> <span class="fl">4</span>, key.pos <span class="op">=</span> <span class="fl">4</span>, key.width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/graphics/layout.html">lcm</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="sfn04_routing_files/figure-html/unnamed-chunk-16-1.png" width="480"></p>
<p>As with the overall network, the paths we calculated are dominated by residential streets. For the purposes of illustration, lets imagine we’re routing for a vehicle that we want to keep away from residential roads, and which has a much lower cost per unit distance on secondary roads:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">weighting_profile</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
  cycleway <span class="op">=</span> <span class="cn">Inf</span>,
  footway <span class="op">=</span> <span class="cn">Inf</span>,
  path <span class="op">=</span> <span class="cn">Inf</span>,
  pedestrian <span class="op">=</span> <span class="cn">Inf</span>,
  residential <span class="op">=</span> <span class="fl">3</span>,
  secondary <span class="op">=</span> <span class="fl">1</span>,
  service <span class="op">=</span> <span class="fl">1</span>,
  track <span class="op">=</span> <span class="fl">10</span>,
  unclassified <span class="op">=</span> <span class="fl">1</span>
<span class="op">)</span>

<span class="va">weighted_net</span> <span class="op">=</span> <span class="va">net</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html">activate</a></span><span class="op">(</span><span class="st">"edges"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>multiplier <span class="op">=</span> <span class="va">weighting_profile</span><span class="op">[</span><span class="va">type</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>weight <span class="op">=</span> <span class="fu"><a href="../reference/spatial_edge_measures.html">edge_length</a></span><span class="op">(</span><span class="op">)</span> <span class="op">*</span> <span class="va">multiplier</span><span class="op">)</span></code></pre></div>
<p>We can now recalculate the routes. The result show routes that avoid residential networks.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">weighted_paths</span> <span class="op">=</span> <span class="fu"><a href="../reference/st_network_paths.html">st_network_paths</a></span><span class="op">(</span><span class="va">weighted_net</span>, from <span class="op">=</span> <span class="fl">495</span>, to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">458</span>, <span class="fl">121</span><span class="op">)</span><span class="op">)</span>

<span class="va">weighted_paths_sf</span> <span class="op">=</span> <span class="va">weighted_net</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html">activate</a></span><span class="op">(</span><span class="st">"edges"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="va">weighted_paths</span><span class="op">$</span><span class="va">edge_paths</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">weighted_paths_sf</span><span class="op">$</span><span class="va">type</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     cycleway      footway         path   pedestrian  residential    secondary </span>
<span class="co">#&gt;            0            0            0            0            9           43 </span>
<span class="co">#&gt;      service        track unclassified </span>
<span class="co">#&gt;            3            0            0</span>

<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="va">net</span>, <span class="st">"edges"</span><span class="op">)</span><span class="op">[</span><span class="st">"type"</span><span class="op">]</span>, lwd <span class="op">=</span> <span class="fl">4</span>,
     key.pos <span class="op">=</span> <span class="cn">NULL</span>, reset <span class="op">=</span> <span class="cn">FALSE</span>, main <span class="op">=</span> <span class="st">"Distance weights"</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">paths_sf</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="va">net</span>, <span class="st">"edges"</span><span class="op">)</span><span class="op">[</span><span class="st">"type"</span><span class="op">]</span>, lwd <span class="op">=</span> <span class="fl">4</span>,
     key.pos <span class="op">=</span> <span class="cn">NULL</span>, reset <span class="op">=</span> <span class="cn">FALSE</span>, main <span class="op">=</span> <span class="st">"Custom weights"</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">weighted_paths_sf</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p><img src="sfn04_routing_files/figure-html/unnamed-chunk-18-1.png" width="50%"><img src="sfn04_routing_files/figure-html/unnamed-chunk-18-2.png" width="50%"></p>
<p>Note that developing more sophisticated routing profiles is beyond the scope of this package. If you need complex mode-specific routing profiles, we recommend looking at routing profiles associated with open source routing engines, such as <a href="https://github.com/fossgis-routing-server/cbf-routing-profiles/blob/master/bike.lua">bike.lua</a> in the OSRM project. Another direction of travel could be to extend on the approach illustrated here, but this work could be well-suited to a separate package that builds on <code>sfnetworks</code> (remembering that sophisticated routing profiles account for nodes and edges). If you’d like to work on such a project to improve mode-specific routing in R by building on this package, please let us know in the <a href="https://github.com/luukvdmeer/sfnetworks/discussions">discussion room</a>!</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Lucas van der Meer, Lorena Abad, Andrea Gilardi, Robin Lovelace.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
